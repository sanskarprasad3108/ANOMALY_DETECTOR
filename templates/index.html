<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dump Truck Anomaly Detection</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a1a2e 50%, #0f0f23 100%);
            color: #ffffff;
            min-height: 100vh;
            overflow-x: hidden;
        }

        .dashboard {
            display: grid;
            grid-template-columns: 300px 1fr 320px;
            grid-template-rows: auto 1fr;
            gap: 15px;
            padding: 15px;
            min-height: 100vh;
        }

        /* Header */
        .header {
            grid-column: 1 / -1;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 25px;
            background: rgba(20, 20, 40, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .title {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .title h1 {
            font-size: 1.8rem;
            background: linear-gradient(90deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 30px rgba(0, 255, 136, 0.3);
        }

        .title-icon {
            font-size: 2rem;
        }

        /* Status Section */
        .status-section {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .system-status {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 10px 25px;
            border-radius: 10px;
            min-width: 200px;
        }

        .status-label {
            font-size: 0.75rem;
            color: #888;
            margin-bottom: 5px;
        }

        .status-value {
            font-size: 1.3rem;
            font-weight: bold;
            letter-spacing: 2px;
        }

        .status-normal {
            background: linear-gradient(135deg, rgba(0, 255, 136, 0.2), rgba(0, 200, 100, 0.1));
            border: 2px solid #00ff88;
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
        }

        .status-normal .status-value {
            color: #00ff88;
        }

        .status-anomaly {
            background: linear-gradient(135deg, rgba(255, 68, 68, 0.3), rgba(200, 50, 50, 0.1));
            border: 2px solid #ff4444;
            box-shadow: 0 0 30px rgba(255, 68, 68, 0.5);
            animation: pulse-red 0.5s ease-in-out infinite;
        }

        .status-anomaly .status-value {
            color: #ff4444;
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 20px rgba(255, 68, 68, 0.5); }
            50% { box-shadow: 0 0 40px rgba(255, 68, 68, 0.8); }
        }

        /* Metrics Display */
        .metrics {
            display: flex;
            gap: 15px;
        }

        .metric-box {
            background: rgba(30, 30, 50, 0.8);
            padding: 10px 20px;
            border-radius: 8px;
            border: 1px solid rgba(0, 255, 136, 0.3);
            text-align: center;
        }

        .metric-label {
            font-size: 0.7rem;
            color: #888;
            text-transform: uppercase;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }

        /* Left Panel */
        .left-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Control Panel */
        .control-panel {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 12px;
            padding: 20px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .panel-title {
            font-size: 1rem;
            color: #00d4ff;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            border-bottom: 1px solid rgba(0, 255, 136, 0.2);
            padding-bottom: 10px;
        }

        .control-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9rem;
            transition: all 0.3s ease;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-normal {
            background: linear-gradient(135deg, #00aa55, #00ff88);
            color: #000;
        }

        .btn-normal:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(0, 255, 136, 0.4);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ff4444, #ff6b6b);
            color: #fff;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(255, 68, 68, 0.4);
        }

        .btn-warning {
            background: linear-gradient(135deg, #ffaa00, #ffcc00);
            color: #000;
            animation: pulse-yellow 1s ease-in-out infinite;
        }

        @keyframes pulse-yellow {
            0%, 100% { box-shadow: 0 0 10px rgba(255, 170, 0, 0.5); }
            50% { box-shadow: 0 0 25px rgba(255, 170, 0, 0.8); }
        }

        .btn-toggle {
            position: relative;
            overflow: hidden;
        }

        /* Toggle Status Indicators */
        .toggle-status {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.3);
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .status-dot.active {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88;
        }

        .status-dot.inactive {
            background: #555;
        }

        .status-dot.danger {
            background: #ff4444;
            box-shadow: 0 0 10px #ff4444;
            animation: blink 0.5s infinite;
        }

        @keyframes blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }

        /* 3D Plot Panel */
        .plot-panel {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
            flex: 1;
        }

        #pca-plot {
            width: 100%;
            height: 280px;
            border-radius: 8px;
        }

        /* Center Panel */
        .center-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* Charts */
        .chart-container {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
            flex: 1;
        }

        .chart-title {
            font-size: 0.9rem;
            color: #00d4ff;
            margin-bottom: 10px;
        }

        #chart-engine, #chart-vibration {
            width: 100%;
            height: 200px;
        }

        /* ========================================
           TRUCK VISUALIZATION - FLAT VECTOR STYLE
           Industrial monitoring dashboard design
           ======================================== */
        
        .truck-panel {
            background: linear-gradient(180deg, rgba(15, 20, 35, 0.95) 0%, rgba(20, 25, 45, 0.95) 100%);
            border-radius: 16px;
            padding: 24px;
            border: 1px solid rgba(0, 255, 136, 0.15);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        .truck-diagram {
            position: relative;
            width: 100%;
            height: 280px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .truck-svg {
            width: 100%;
            height: 100%;
            max-width: 520px;
            filter: drop-shadow(0 8px 16px rgba(0, 0, 0, 0.4));
        }

        /* ========================================
           DIAGNOSTIC OVERLAY ZONES
           Semi-transparent glow areas for components
           ======================================== */
        
        .diagnostic-zone {
            transition: all 0.3s ease !important;
            pointer-events: none;
        }
        
        /* Normal state - soft green glow */
        .zone-normal {
            fill: rgba(0, 255, 136, 0.12) !important;
            opacity: 0.4 !important;
            filter: drop-shadow(0 0 6px rgba(0, 255, 136, 0.3)) !important;
        }
        
        /* Anomaly state - BRIGHT RED GLOW with pulse */
        .zone-fault {
            fill: rgba(255, 50, 50, 0.55) !important;
            opacity: 0.85 !important;
            filter: drop-shadow(0 0 25px rgba(255, 50, 50, 1)) drop-shadow(0 0 50px rgba(255, 0, 0, 0.8)) !important;
            animation: zone-pulse-red 0.6s ease-in-out infinite !important;
        }
        
        /* Warning state - amber glow */
        .zone-warning {
            fill: rgba(255, 170, 0, 0.3);
            filter: drop-shadow(0 0 15px rgba(255, 170, 0, 0.6));
            animation: zone-pulse-amber 1.2s ease-in-out infinite;
        }
        
        @keyframes zone-pulse-red {
            0%, 100% { 
                opacity: 0.7;
                fill: rgba(255, 50, 50, 0.5);
                filter: drop-shadow(0 0 20px rgba(255, 50, 50, 0.9)) drop-shadow(0 0 40px rgba(255, 0, 0, 0.6));
            }
            50% { 
                opacity: 1;
                fill: rgba(255, 30, 30, 0.7);
                filter: drop-shadow(0 0 35px rgba(255, 50, 50, 1)) drop-shadow(0 0 70px rgba(255, 0, 0, 0.9));
            }
        }
        
        @keyframes zone-pulse-amber {
            0%, 100% { 
                opacity: 0.5;
                filter: drop-shadow(0 0 12px rgba(255, 170, 0, 0.5));
            }
            50% { 
                opacity: 0.8;
                filter: drop-shadow(0 0 25px rgba(255, 170, 0, 0.9));
            }
        }

        /* ========================================
           COMPONENT LABELS - Floating pill badges
           ======================================== */
        
        .component-label {
            position: absolute;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.68rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            backdrop-filter: blur(8px);
            text-transform: uppercase;
            z-index: 10;
        }

        .component-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            flex-shrink: 0;
        }

        /* Normal state styling */
        .component-normal {
            background: rgba(0, 255, 136, 0.15);
            border: 1.5px solid rgba(0, 255, 136, 0.6);
            color: #00ff88;
            box-shadow: 0 4px 15px rgba(0, 255, 136, 0.2);
        }

        .component-normal .component-dot {
            background: #00ff88;
            box-shadow: 0 0 10px #00ff88, 0 0 20px rgba(0, 255, 136, 0.5);
        }

        /* Fault/Anomaly state styling */
        .component-fault {
            background: rgba(255, 68, 68, 0.25);
            border: 1.5px solid rgba(255, 68, 68, 0.8);
            color: #ff6b6b;
            box-shadow: 0 4px 20px rgba(255, 68, 68, 0.4);
            animation: label-pulse-fault 0.6s ease-in-out infinite;
        }

        .component-fault .component-dot {
            background: #ff4444;
            box-shadow: 0 0 12px #ff4444, 0 0 24px rgba(255, 68, 68, 0.7);
            animation: dot-blink 0.4s ease-in-out infinite;
        }
        
        @keyframes label-pulse-fault {
            0%, 100% { 
                box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
                transform: scale(1);
            }
            50% { 
                box-shadow: 0 4px 30px rgba(255, 68, 68, 0.6);
                transform: scale(1.02);
            }
        }
        
        @keyframes dot-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Label positioning - optimized for flat truck design */
        #engine-label { 
            top: 35px; 
            left: 8%; 
        }
        #hydraulic-label { 
            top: 35px; 
            right: 15%; 
        }
        #chassis-label { 
            bottom: 55px; 
            left: 50%;
            transform: translateX(-50%);
        }
        #wheels-label { 
            bottom: 15px; 
            right: 18%; 
        }
        
        /* Responsive label positioning */
        @media (max-width: 600px) {
            #engine-label { left: 5%; top: 25px; }
            #hydraulic-label { right: 5%; top: 25px; }
            #chassis-label { bottom: 45px; }
            #wheels-label { right: 10%; bottom: 10px; }
        }

        /* Right Panel - Sensor Readings */
        .right-panel {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .sensor-panel {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
            flex: 1;
        }

        .sensor-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .sensor-card {
            background: rgba(10, 10, 30, 0.8);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(0, 255, 136, 0.15);
            transition: all 0.3s ease;
        }

        .sensor-card.anomaly {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.1);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }

        .sensor-name {
            font-size: 0.65rem;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .sensor-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #00ff88;
            font-family: 'Courier New', monospace;
        }

        .sensor-card.anomaly .sensor-value {
            color: #ff4444;
        }

        /* Simulation Controls */
        .sim-controls {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(0, 255, 136, 0.2);
        }

        .sim-buttons {
            display: flex;
            gap: 10px;
        }

        .sim-buttons .btn {
            flex: 1;
        }

        /* ========================================
           FAILURE PROBABILITY PANEL
           Shows weighted failure rates per component
           ======================================== */
        .probability-panel {
            background: rgba(20, 20, 40, 0.9);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 170, 0, 0.3);
        }

        .probability-grid {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .probability-item {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px 12px;
            background: rgba(10, 10, 30, 0.6);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.3s ease;
        }

        .probability-item.failing {
            border-color: #ff4444;
            background: rgba(255, 68, 68, 0.15);
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }

        .probability-item.failing .prob-component {
            color: #ff6b6b;
        }

        .probability-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .prob-component {
            font-size: 0.75rem;
            font-weight: 700;
            color: #00d4ff;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .prob-percentage {
            font-size: 0.9rem;
            font-weight: bold;
            color: #ffaa00;
            font-family: 'Courier New', monospace;
        }

        .probability-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.4);
            border-radius: 4px;
            overflow: hidden;
        }

        .probability-bar {
            height: 100%;
            border-radius: 4px;
            transition: width 0.5s ease, background 0.3s ease;
        }

        .probability-bar.engine {
            background: linear-gradient(90deg, #ff6b6b, #ff4444);
        }

        .probability-bar.hydraulic {
            background: linear-gradient(90deg, #ffd93d, #ffaa00);
        }

        .probability-bar.wheels {
            background: linear-gradient(90deg, #6bcb77, #4CAF50);
        }

        .probability-bar.chassis {
            background: linear-gradient(90deg, #4fc3f7, #00d4ff);
        }

        .prob-status {
            font-size: 0.6rem;
            color: #666;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .prob-status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #00ff88;
        }

        .prob-status-dot.failing {
            background: #ff4444;
            animation: prob-dot-pulse 0.5s ease-in-out infinite;
        }

        @keyframes prob-dot-pulse {
            0%, 100% { opacity: 1; box-shadow: 0 0 4px #ff4444; }
            50% { opacity: 0.5; box-shadow: 0 0 8px #ff4444; }
        }

        .probability-legend {
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 0.6rem;
            color: #666;
            text-align: center;
            line-height: 1.4;
        }

        /* Footer */
        .footer {
            grid-column: 1 / -1;
            text-align: center;
            padding: 10px;
            color: #555;
            font-size: 0.8rem;
        }

        /* Responsive */
        @media (max-width: 1400px) {
            .dashboard {
                grid-template-columns: 280px 1fr 280px;
            }
        }

        @media (max-width: 1200px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard">
        <!-- Header -->
        <div class="header">
            <div class="title">
                <span class="title-icon">üöõ</span>
                <h1>Dump Truck Anomaly Detection</h1>
            </div>
            
            <div class="status-section">
                <div class="metrics">
                    <div class="metric-box">
                        <div class="metric-label">Reconstruction Loss</div>
                        <div class="metric-value" id="recon-error">0.000</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-label">Threshold</div>
                        <div class="metric-value" id="threshold-value">0.000</div>
                    </div>
                </div>
                
                <div class="system-status status-normal" id="system-status">
                    <div class="status-label">System Status</div>
                    <div class="status-value" id="status-text">SYSTEM NORMAL</div>
                </div>
            </div>
        </div>

        <!-- Left Panel -->
        <div class="left-panel">
            <div class="control-panel">
                <div class="panel-title">
                    <span>‚öôÔ∏è</span> Simulation Controls
                </div>
                <div class="control-buttons">
                    <button class="btn btn-normal" id="btn-simulate" onclick="toggleSimulation()">
                        üìä Simulate Normal
                    </button>
                    <button class="btn btn-danger" id="btn-inject" onclick="toggleInjection()">
                        üî• INJECT FAILURE üî•
                    </button>
                </div>
                <div class="toggle-status">
                    <div class="status-item">
                        <span class="status-dot" id="dot-injection"></span>
                        <span id="label-injection">Inject Failure: OFF</span>
                    </div>
                    <div class="status-item">
                        <span class="status-dot" id="dot-auto"></span>
                        <span id="label-auto">Auto Mode: OFF</span>
                    </div>
                </div>
            </div>

            <div class="plot-panel">
                <div class="panel-title">
                    <span>üîÆ</span> 3D Feature Space (PCA)
                </div>
                <div id="pca-plot"></div>
            </div>
        </div>

        <!-- Center Panel -->
        <div class="center-panel">
            <div class="chart-container">
                <div class="chart-title">üìà Engine Temp & Hydraulic Pressure</div>
                <div id="chart-engine"></div>
            </div>
            
            <div class="chart-container">
                <div class="chart-title">üìä Vibration & Speed</div>
                <div id="chart-vibration"></div>
            </div>

            <div class="truck-panel">
                <div class="panel-title">
                    <span>üîß</span> Real-Time Diagnostics
                </div>
                <div class="truck-diagram">
                    <!-- ========================================
                         FLAT VECTOR DUMP TRUCK - Industrial Style
                         Modern colored illustration with diagnostic overlays
                         ======================================== -->
                    <svg class="truck-svg" viewBox="0 0 520 240" preserveAspectRatio="xMidYMid meet">
                        <defs>
                            <!-- Gradient definitions for depth -->
                            <linearGradient id="cabinGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#F5A623;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#D4880F;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="bedGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#F7C948;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#F5B800;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#D4940A;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="chassisGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#4A4A4A;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2D2D2D;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="wheelGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#3D3D3D;stop-opacity:1" />
                                <stop offset="50%" style="stop-color:#1A1A1A;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#2A2A2A;stop-opacity:1" />
                            </linearGradient>
                            <linearGradient id="glassGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                <stop offset="0%" style="stop-color:#87CEEB;stop-opacity:0.9" />
                                <stop offset="50%" style="stop-color:#5CB8E8;stop-opacity:0.85" />
                                <stop offset="100%" style="stop-color:#4AA8D8;stop-opacity:0.9" />
                            </linearGradient>
                            <linearGradient id="loadGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                                <stop offset="0%" style="stop-color:#9E8B7D;stop-opacity:1" />
                                <stop offset="100%" style="stop-color:#7A6B5F;stop-opacity:1" />
                            </linearGradient>
                            <!-- Glow filters for diagnostic overlays -->
                            <filter id="glowGreen" x="-50%" y="-50%" width="200%" height="200%">
                                <feDropShadow dx="0" dy="0" stdDeviation="4" flood-color="#00ff88" flood-opacity="0.6"/>
                            </filter>
                            
                            <!-- RED GLOW FILTER - Applied to truck part groups when anomaly detected -->
                            <filter id="glowRed" x="-100%" y="-100%" width="300%" height="300%">
                                <feDropShadow dx="0" dy="0" stdDeviation="8" flood-color="#ff0000" flood-opacity="1"/>
                                <feDropShadow dx="0" dy="0" stdDeviation="15" flood-color="#ff3333" flood-opacity="0.8"/>
                                <feDropShadow dx="0" dy="0" stdDeviation="25" flood-color="#ff5555" flood-opacity="0.5"/>
                            </filter>
                            
                            <!-- Animated red pulse filter -->
                            <filter id="glowRedPulse" x="-100%" y="-100%" width="300%" height="300%">
                                <feDropShadow dx="0" dy="0" stdDeviation="12" flood-color="#ff0000" flood-opacity="1">
                                    <animate attributeName="stdDeviation" values="8;15;8" dur="0.6s" repeatCount="indefinite"/>
                                </feDropShadow>
                                <feDropShadow dx="0" dy="0" stdDeviation="20" flood-color="#ff3333" flood-opacity="0.7">
                                    <animate attributeName="stdDeviation" values="15;25;15" dur="0.6s" repeatCount="indefinite"/>
                                </feDropShadow>
                            </filter>
                        </defs>
                        
                        <!-- ======== GROUND SHADOW ======== -->
                        <ellipse cx="270" cy="218" rx="200" ry="12" fill="rgba(0,0,0,0.3)"/>
                        
                        <!-- ======== CHASSIS / FRAME ======== -->
                        <g id="chassis-group">
                            <!-- Main chassis beam -->
                            <rect x="55" y="155" width="380" height="18" rx="4" fill="url(#chassisGradient)"/>
                            <!-- Front axle housing -->
                            <rect x="80" y="168" width="45" height="12" rx="3" fill="#3A3A3A"/>
                            <!-- Rear axle housing -->
                            <rect x="295" y="168" width="100" height="12" rx="3" fill="#3A3A3A"/>
                            <!-- Chassis diagnostic overlay zone -->
                            <rect id="chassis-zone" class="diagnostic-zone zone-normal" x="55" y="150" width="380" height="30" rx="6"/>
                        </g>
                        
                        <!-- ======== DUMP BED (Tipper Body) ======== -->
                        <g id="hydraulic-group">
                            <!-- Bed base -->
                            <path d="M180 65 L180 150 L440 150 L470 65 Z" fill="url(#bedGradient)" stroke="#C4A000" stroke-width="2"/>
                            <!-- Bed reinforcement stripes -->
                            <line x1="210" y1="70" x2="195" y2="145" stroke="#D4940A" stroke-width="3"/>
                            <line x1="260" y1="70" x2="235" y2="145" stroke="#D4940A" stroke-width="3"/>
                            <line x1="310" y1="70" x2="275" y2="145" stroke="#D4940A" stroke-width="3"/>
                            <line x1="360" y1="70" x2="315" y2="145" stroke="#D4940A" stroke-width="3"/>
                            <line x1="410" y1="70" x2="355" y2="145" stroke="#D4940A" stroke-width="3"/>
                            <!-- Bed top rail -->
                            <rect x="178" y="58" width="295" height="10" rx="2" fill="#E8B600"/>
                            <!-- Load material (gravel/dirt) -->
                            <ellipse cx="320" cy="55" rx="120" ry="22" fill="url(#loadGradient)"/>
                            <ellipse cx="290" cy="48" rx="80" ry="14" fill="#8B7D6B"/>
                            <ellipse cx="350" cy="50" rx="60" ry="12" fill="#7A6B5F"/>
                            <!-- Hydraulic cylinder -->
                            <rect x="185" y="120" width="10" height="35" rx="2" fill="#6B6B6B"/>
                            <rect x="183" y="115" width="14" height="8" rx="2" fill="#888"/>
                            <!-- Hydraulic diagnostic overlay zone -->
                            <rect id="hydraulic-zone" class="diagnostic-zone zone-normal" x="175" y="50" width="300" height="108" rx="8"/>
                        </g>
                        
                        <!-- ======== CABIN ======== -->
                        <g id="engine-group">
                            <!-- Cabin main body -->
                            <path d="M50 85 L50 155 L175 155 L175 75 L120 55 L70 55 L50 75 Z" fill="url(#cabinGradient)" stroke="#C4880F" stroke-width="2"/>
                            <!-- Cabin roof -->
                            <rect x="65" y="48" width="60" height="10" rx="4" fill="#E89A1C"/>
                            <!-- Door panel line -->
                            <line x1="90" y1="80" x2="90" y2="150" stroke="#C4880F" stroke-width="2"/>
                            <!-- Door handle -->
                            <rect x="95" y="115" width="18" height="5" rx="2" fill="#888"/>
                            <!-- Front windshield -->
                            <path d="M55 78 L70 60 L115 60 L115 78 Z" fill="url(#glassGradient)" stroke="#4AA8D8" stroke-width="1.5"/>
                            <!-- Side window -->
                            <rect x="95" y="62" width="75" height="45" rx="4" fill="url(#glassGradient)" stroke="#4AA8D8" stroke-width="1.5"/>
                            <!-- Window divider -->
                            <line x1="135" y1="62" x2="135" y2="107" stroke="#C4880F" stroke-width="2"/>
                            <!-- Headlight -->
                            <ellipse cx="54" cy="130" rx="8" ry="10" fill="#FFFDE7" stroke="#FFD54F" stroke-width="2"/>
                            <ellipse cx="54" cy="130" rx="4" ry="5" fill="#FFF9C4"/>
                            <!-- Side mirror -->
                            <rect x="42" y="72" width="6" height="20" rx="2" fill="#3A3A3A"/>
                            <rect x="35" y="75" width="10" height="12" rx="2" fill="#5CB8E8"/>
                            <!-- Exhaust stack -->
                            <rect x="155" y="35" width="8" height="45" rx="2" fill="#4A4A4A"/>
                            <ellipse cx="159" cy="35" rx="5" ry="3" fill="#3A3A3A"/>
                            <!-- Front bumper -->
                            <rect x="42" y="148" width="135" height="10" rx="3" fill="#3A3A3A"/>
                            <!-- Front grille -->
                            <rect x="48" y="135" width="25" height="15" rx="2" fill="#2D2D2D"/>
                            <line x1="52" y1="137" x2="52" y2="148" stroke="#4A4A4A" stroke-width="2"/>
                            <line x1="58" y1="137" x2="58" y2="148" stroke="#4A4A4A" stroke-width="2"/>
                            <line x1="64" y1="137" x2="64" y2="148" stroke="#4A4A4A" stroke-width="2"/>
                            <!-- Engine diagnostic overlay zone -->
                            <rect id="engine-zone" class="diagnostic-zone zone-normal" x="42" y="50" width="140" height="115" rx="8"/>
                        </g>
                        
                        <!-- ======== WHEELS ======== -->
                        <g id="wheels-group">
                            <!-- Front wheel -->
                            <circle cx="102" cy="185" r="32" fill="url(#wheelGradient)" stroke="#1A1A1A" stroke-width="3"/>
                            <circle cx="102" cy="185" r="22" fill="#2D2D2D"/>
                            <circle cx="102" cy="185" r="12" fill="#4A4A4A" stroke="#5A5A5A" stroke-width="2"/>
                            <circle cx="102" cy="185" r="5" fill="#6A6A6A"/>
                            <!-- Front wheel tread marks -->
                            <circle cx="102" cy="185" r="28" fill="none" stroke="#2A2A2A" stroke-width="4" stroke-dasharray="8 6"/>
                            
                            <!-- Rear wheel 1 -->
                            <circle cx="315" cy="185" r="32" fill="url(#wheelGradient)" stroke="#1A1A1A" stroke-width="3"/>
                            <circle cx="315" cy="185" r="22" fill="#2D2D2D"/>
                            <circle cx="315" cy="185" r="12" fill="#4A4A4A" stroke="#5A5A5A" stroke-width="2"/>
                            <circle cx="315" cy="185" r="5" fill="#6A6A6A"/>
                            <circle cx="315" cy="185" r="28" fill="none" stroke="#2A2A2A" stroke-width="4" stroke-dasharray="8 6"/>
                            
                            <!-- Rear wheel 2 -->
                            <circle cx="385" cy="185" r="32" fill="url(#wheelGradient)" stroke="#1A1A1A" stroke-width="3"/>
                            <circle cx="385" cy="185" r="22" fill="#2D2D2D"/>
                            <circle cx="385" cy="185" r="12" fill="#4A4A4A" stroke="#5A5A5A" stroke-width="2"/>
                            <circle cx="385" cy="185" r="5" fill="#6A6A6A"/>
                            <circle cx="385" cy="185" r="28" fill="none" stroke="#2A2A2A" stroke-width="4" stroke-dasharray="8 6"/>
                            
                            <!-- Wheel diagnostic overlay zone (under wheels) -->
                            <ellipse id="wheels-zone" class="diagnostic-zone zone-normal" cx="260" cy="185" rx="180" ry="38"/>
                        </g>
                        
                        <!-- ======== WHEEL STROKE INDICATORS (for JS updates) ======== -->
                        <circle id="wheel-fl" cx="102" cy="185" r="32" fill="none" stroke="transparent" stroke-width="4"/>
                        <circle id="wheel-rl" cx="315" cy="185" r="32" fill="none" stroke="transparent" stroke-width="4"/>
                        <circle id="wheel-rr" cx="385" cy="185" r="32" fill="none" stroke="transparent" stroke-width="4"/>
                        
                        <!-- Hidden elements for JS compatibility -->
                        <rect id="engine-area" x="42" y="50" width="140" height="115" fill="none" stroke="transparent"/>
                        <line id="hydraulic-line" x1="175" y1="50" x2="475" y2="50" stroke="transparent" stroke-width="1"/>
                    </svg>
                    
                    <!-- ======== FLOATING DIAGNOSTIC LABELS ======== -->
                    <div class="component-label component-normal" id="engine-label">
                        <span class="component-dot"></span>ENGINE
                    </div>
                    <div class="component-label component-normal" id="hydraulic-label">
                        <span class="component-dot"></span>HYDRAULICS
                    </div>
                    <div class="component-label component-normal" id="chassis-label">
                        <span class="component-dot"></span>CHASSIS
                    </div>
                    <div class="component-label component-normal" id="wheels-label">
                        <span class="component-dot"></span>WHEELS
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div class="right-panel">
            <div class="sensor-panel">
                <div class="panel-title">
                    <span>üì°</span> Sensor Readings
                </div>
                <div class="sensor-grid" id="sensor-grid">
                    <!-- Sensors will be dynamically populated -->
                </div>
            </div>

            <!-- Failure Probability Panel -->
            <div class="probability-panel">
                <div class="panel-title">
                    <span>üìä</span> Failure Probability
                </div>
                <div class="probability-grid" id="probability-grid">
                    <!-- Engine -->
                    <div class="probability-item" id="prob-engine">
                        <div class="probability-header">
                            <span class="prob-component">üî• Engine</span>
                            <span class="prob-percentage" id="prob-engine-pct">40%</span>
                        </div>
                        <div class="probability-bar-container">
                            <div class="probability-bar engine" id="prob-engine-bar" style="width: 40%;"></div>
                        </div>
                        <div class="prob-status">
                            <span class="prob-status-dot" id="prob-engine-dot"></span>
                            <span id="prob-engine-status">Normal</span>
                        </div>
                    </div>
                    <!-- Hydraulic -->
                    <div class="probability-item" id="prob-hydraulic">
                        <div class="probability-header">
                            <span class="prob-component">üíß Hydraulics</span>
                            <span class="prob-percentage" id="prob-hydraulic-pct">30%</span>
                        </div>
                        <div class="probability-bar-container">
                            <div class="probability-bar hydraulic" id="prob-hydraulic-bar" style="width: 30%;"></div>
                        </div>
                        <div class="prob-status">
                            <span class="prob-status-dot" id="prob-hydraulic-dot"></span>
                            <span id="prob-hydraulic-status">Normal</span>
                        </div>
                    </div>
                    <!-- Wheels -->
                    <div class="probability-item" id="prob-wheels">
                        <div class="probability-header">
                            <span class="prob-component">‚öôÔ∏è Wheels</span>
                            <span class="prob-percentage" id="prob-wheels-pct">20%</span>
                        </div>
                        <div class="probability-bar-container">
                            <div class="probability-bar wheels" id="prob-wheels-bar" style="width: 20%;"></div>
                        </div>
                        <div class="prob-status">
                            <span class="prob-status-dot" id="prob-wheels-dot"></span>
                            <span id="prob-wheels-status">Normal</span>
                        </div>
                    </div>
                    <!-- Chassis -->
                    <div class="probability-item" id="prob-chassis">
                        <div class="probability-header">
                            <span class="prob-component">üõ°Ô∏è Chassis</span>
                            <span class="prob-percentage" id="prob-chassis-pct">10%</span>
                        </div>
                        <div class="probability-bar-container">
                            <div class="probability-bar chassis" id="prob-chassis-bar" style="width: 10%;"></div>
                        </div>
                        <div class="prob-status">
                            <span class="prob-status-dot" id="prob-chassis-dot"></span>
                            <span id="prob-chassis-status">Normal</span>
                        </div>
                    </div>
                </div>
                <div class="probability-legend">
                    ‚ö†Ô∏è Higher % = More likely to fail when injection is active
                </div>
            </div>

            <div class="sim-controls">
                <div class="panel-title">
                    <span>üéÆ</span> Quick Controls
                </div>
                <div class="sim-buttons">
                    <button class="btn btn-normal" onclick="startStream()">‚ñ∂ Start Stream</button>
                    <button class="btn btn-danger" onclick="stopStream()">‚èπ Stop</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global state
        let simulationInterval = null;
        let isStreaming = false;
        let injectionActive = false;
        let activeFailedComponents = [];  // Track which components are currently failing
        
        // PCA scatter data
        let pcaNormalX = [], pcaNormalY = [], pcaNormalZ = [];
        let pcaAnomalyX = [], pcaAnomalyY = [], pcaAnomalyZ = [];
        const MAX_PCA_POINTS = 200;

        // Initialize plots
        function initPlots() {
            // PCA 3D Plot
            const pcaLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(10,10,30,0.5)',
                margin: { l: 0, r: 0, t: 0, b: 0 },
                scene: {
                    xaxis: { 
                        title: '', 
                        showgrid: true, 
                        gridcolor: '#1a3a5c',
                        zerolinecolor: '#1a3a5c',
                        showticklabels: false
                    },
                    yaxis: { 
                        title: '', 
                        showgrid: true, 
                        gridcolor: '#1a3a5c',
                        zerolinecolor: '#1a3a5c',
                        showticklabels: false
                    },
                    zaxis: { 
                        title: '', 
                        showgrid: true, 
                        gridcolor: '#1a3a5c',
                        zerolinecolor: '#1a3a5c',
                        showticklabels: false
                    },
                    bgcolor: 'rgba(10,10,30,0.5)',
                    camera: {
                        eye: { x: 1.5, y: 1.5, z: 1.2 }
                    }
                },
                showlegend: false
            };

            Plotly.newPlot('pca-plot', [
                {
                    x: [], y: [], z: [],
                    mode: 'markers',
                    type: 'scatter3d',
                    marker: { size: 4, color: '#00ff88', opacity: 0.7 },
                    name: 'Normal'
                },
                {
                    x: [], y: [], z: [],
                    mode: 'markers',
                    type: 'scatter3d',
                    marker: { size: 6, color: '#ff4444', opacity: 0.9 },
                    name: 'Anomaly'
                }
            ], pcaLayout, { responsive: true, displayModeBar: false });

            // Time series charts
            const chartLayout = {
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(10,10,30,0.3)',
                margin: { l: 40, r: 10, t: 10, b: 30 },
                xaxis: { 
                    showgrid: true, 
                    gridcolor: '#1a3a5c',
                    color: '#888'
                },
                yaxis: { 
                    showgrid: true, 
                    gridcolor: '#1a3a5c',
                    color: '#888'
                },
                showlegend: true,
                legend: { 
                    x: 0, 
                    y: 1, 
                    font: { color: '#888', size: 10 },
                    bgcolor: 'rgba(0,0,0,0)'
                }
            };

            Plotly.newPlot('chart-engine', [
                { x: [], y: [], mode: 'lines', name: 'Engine Temp', line: { color: '#ff6b6b', width: 2 } },
                { x: [], y: [], mode: 'lines', name: 'Hydraulic', line: { color: '#ffd93d', width: 2 } }
            ], chartLayout, { responsive: true, displayModeBar: false });

            Plotly.newPlot('chart-vibration', [
                { x: [], y: [], mode: 'lines', name: 'Vibration', line: { color: '#ff6b6b', width: 2 } },
                { x: [], y: [], mode: 'lines', name: 'Speed', line: { color: '#6bcb77', width: 2 } }
            ], chartLayout, { responsive: true, displayModeBar: false });
        }

        // Update PCA plot
        function updatePCAPlot(coords, isAnomaly) {
            if (isAnomaly) {
                pcaAnomalyX.push(coords[0]);
                pcaAnomalyY.push(coords[1]);
                pcaAnomalyZ.push(coords[2]);
                
                if (pcaAnomalyX.length > MAX_PCA_POINTS / 4) {
                    pcaAnomalyX.shift();
                    pcaAnomalyY.shift();
                    pcaAnomalyZ.shift();
                }
            } else {
                pcaNormalX.push(coords[0]);
                pcaNormalY.push(coords[1]);
                pcaNormalZ.push(coords[2]);
                
                if (pcaNormalX.length > MAX_PCA_POINTS) {
                    pcaNormalX.shift();
                    pcaNormalY.shift();
                    pcaNormalZ.shift();
                }
            }

            Plotly.update('pca-plot', {
                x: [pcaNormalX, pcaAnomalyX],
                y: [pcaNormalY, pcaAnomalyY],
                z: [pcaNormalZ, pcaAnomalyZ]
            });
        }

        // Update time series charts
        function updateCharts(timeSeries) {
            const timestamps = timeSeries.timestamps;
            
            Plotly.update('chart-engine', {
                x: [timestamps, timestamps],
                y: [timeSeries.engine_temp, timeSeries.hydraulic_pressure]
            });

            Plotly.update('chart-vibration', {
                x: [timestamps, timestamps],
                y: [timeSeries.vibration, timeSeries.speed]
            });
        }

        // Update sensor readings with PER-SENSOR anomaly highlighting
        // Only sensors in anomalousParams will turn RED, others stay GREEN
        function updateSensorReadings(sensors, isAnomaly, anomalousParams = []) {
            const grid = document.getElementById('sensor-grid');
            grid.innerHTML = '';
            
            for (const [name, value] of Object.entries(sensors)) {
                const card = document.createElement('div');
                // Check if THIS SPECIFIC sensor is in the anomalous list
                const isSensorAnomalous = anomalousParams.includes(name);
                card.className = 'sensor-card' + (isSensorAnomalous ? ' anomaly' : '');
                card.innerHTML = `
                    <div class="sensor-name">${name}</div>
                    <div class="sensor-value">${value.toFixed(2)}</div>
                `;
                grid.appendChild(card);
            }
        }

        // Update system status
        function updateSystemStatus(isAnomaly, reconError, threshold) {
            const statusBox = document.getElementById('system-status');
            const statusText = document.getElementById('status-text');
            const reconDisplay = document.getElementById('recon-error');
            const thresholdDisplay = document.getElementById('threshold-value');

            reconDisplay.textContent = reconError.toFixed(4);
            thresholdDisplay.textContent = threshold.toFixed(4);

            if (isAnomaly) {
                statusBox.className = 'system-status status-anomaly';
                statusText.textContent = '‚ö†Ô∏è ANOMALY DETECTED';
            } else {
                statusBox.className = 'system-status status-normal';
                statusText.textContent = 'SYSTEM NORMAL';
            }
        }

        // ============================================================
        // UPDATE TRUCK COMPONENTS - APPLY GLOW TO ACTUAL TRUCK PARTS
        // Uses SVG filter on the VISUAL groups, not invisible overlays
        // ============================================================
        function updateTruckComponents(affected) {
            // EXACT ID MAPPING - Backend key ‚Üí ACTUAL VISUAL TRUCK PART GROUP
            const COMPONENT_TO_GROUP_ID = {
                'engine': 'engine-group',       // The actual cabin/engine SVG group
                'hydraulic': 'hydraulic-group', // The actual dump bed SVG group
                'chassis': 'chassis-group',     // The actual chassis SVG group
                'wheels': 'wheels-group'        // The actual wheels SVG group
            };
            
            const COMPONENT_TO_ZONE_ID = {
                'engine': 'engine-zone',
                'hydraulic': 'hydraulic-zone',
                'chassis': 'chassis-zone',
                'wheels': 'wheels-zone'
            };
            
            const COMPONENT_TO_LABEL_ID = {
                'engine': 'engine-label',
                'hydraulic': 'hydraulic-label',
                'chassis': 'chassis-label',
                'wheels': 'wheels-label'
            };
            
            // STEP 1: Process each component
            Object.keys(COMPONENT_TO_GROUP_ID).forEach(comp => {
                const groupId = COMPONENT_TO_GROUP_ID[comp];
                const zoneId = COMPONENT_TO_ZONE_ID[comp];
                const labelId = COMPONENT_TO_LABEL_ID[comp];
                
                const group = document.getElementById(groupId);  // ACTUAL VISUAL PART
                const zone = document.getElementById(zoneId);    // Overlay zone
                const label = document.getElementById(labelId);  // Floating label
                
                const hasAnomaly = affected && affected[comp] === true;
                
                // FORCE update floating label
                if (label) {
                    label.className = hasAnomaly 
                        ? 'component-label component-fault' 
                        : 'component-label component-normal';
                }
                
                // =====================================================
                // KEY FIX: Apply SVG filter DIRECTLY to truck part group
                // This makes the ACTUAL YELLOW PARTS glow red!
                // =====================================================
                if (group) {
                    if (hasAnomaly) {
                        // Apply red glow filter to the ACTUAL TRUCK PART
                        group.style.filter = 'url(#glowRedPulse)';
                        group.style.transition = 'filter 0.3s ease';
                    } else {
                        // Remove filter - show normal state
                        group.style.filter = '';
                    }
                }
                
                // Also update overlay zone for additional visual feedback
                if (zone) {
                    zone.classList.remove('zone-normal', 'zone-fault', 'zone-warning');
                    if (hasAnomaly) {
                        zone.classList.add('zone-fault');
                        zone.style.fill = 'rgba(255, 50, 50, 0.5)';
                        zone.style.opacity = '0.8';
                    } else {
                        zone.classList.add('zone-normal');
                        zone.style.fill = '';
                        zone.style.opacity = '';
                    }
                }
            });

            // Update wheel stroke indicators (for additional visual feedback)
            const wheelColor = affected.wheels ? '#ff4444' : 'transparent';
            const wheelStroke = affected.wheels ? '4' : '0';
            document.getElementById('wheel-fl').setAttribute('stroke', wheelColor);
            document.getElementById('wheel-fl').setAttribute('stroke-width', wheelStroke);
            document.getElementById('wheel-rl').setAttribute('stroke', wheelColor);
            document.getElementById('wheel-rl').setAttribute('stroke-width', wheelStroke);
            document.getElementById('wheel-rr').setAttribute('stroke', wheelColor);
            document.getElementById('wheel-rr').setAttribute('stroke-width', wheelStroke);
            
            // Legacy element updates (kept for compatibility)
            const engineColor = affected.engine ? '#ff4444' : 'transparent';
            document.getElementById('engine-area').setAttribute('stroke', engineColor);
            
            const hydraulicColor = affected.hydraulic ? '#ff4444' : 'transparent';
            document.getElementById('hydraulic-line').setAttribute('stroke', hydraulicColor);
        }

        // ============================================================
        // UPDATE FAILURE PROBABILITY PANEL
        // Shows weighted probabilities and highlights failing components
        // ============================================================
        function updateFailureProbabilities(probabilities, failedComponents) {
            const components = ['engine', 'hydraulic', 'wheels', 'chassis'];
            
            components.forEach(comp => {
                const item = document.getElementById(`prob-${comp}`);
                const pctElement = document.getElementById(`prob-${comp}-pct`);
                const barElement = document.getElementById(`prob-${comp}-bar`);
                const dotElement = document.getElementById(`prob-${comp}-dot`);
                const statusElement = document.getElementById(`prob-${comp}-status`);
                
                if (!item || !probabilities) return;
                
                // Get probability for this component
                const probability = probabilities[comp] || 0;
                const pctValue = Math.round(probability * 100);
                
                // Update percentage display
                pctElement.textContent = `${pctValue}%`;
                
                // Update bar width
                barElement.style.width = `${pctValue}%`;
                
                // Check if this component is currently failing
                const isFailing = failedComponents && failedComponents.includes(comp);
                
                // Update visual state
                if (isFailing) {
                    item.classList.add('failing');
                    dotElement.classList.add('failing');
                    statusElement.textContent = '‚ö†Ô∏è FAILING';
                    statusElement.style.color = '#ff6b6b';
                } else {
                    item.classList.remove('failing');
                    dotElement.classList.remove('failing');
                    statusElement.textContent = 'Normal';
                    statusElement.style.color = '#666';
                }
            });
        }

        // Toggle injection
        async function toggleInjection() {
            try {
                const response = await fetch('/toggle_injection', { method: 'POST' });
                const data = await response.json();
                injectionActive = data.inject_anomaly;
                activeFailedComponents = data.failed_components || [];
                updateInjectionUI();
            } catch (error) {
                console.error('Error toggling injection:', error);
            }
        }

        // Update injection UI with component-based failure display
        function updateInjectionUI() {
            const btn = document.getElementById('btn-inject');
            const dot = document.getElementById('dot-injection');
            const label = document.getElementById('label-injection');

            if (injectionActive) {
                btn.className = 'btn btn-warning';
                // Show which components are failing
                const failureText = activeFailedComponents.length > 0 
                    ? activeFailedComponents.map(c => c.toUpperCase()).join(' + ')
                    : 'ACTIVE';
                btn.innerHTML = `üõë STOP: ${failureText} üõë`;
                dot.className = 'status-dot danger';
                label.textContent = `Failing: ${failureText}`;
            } else {
                btn.className = 'btn btn-danger';
                btn.innerHTML = 'üî• INJECT FAILURE üî•';
                dot.className = 'status-dot inactive';
                label.textContent = 'Inject Failure: OFF';
                activeFailedComponents = [];
            }
        }

        // Toggle simulation
        function toggleSimulation() {
            if (isStreaming) {
                stopStream();
            } else {
                startStream();
            }
        }

        // Fetch data
        async function fetchData() {
            try {
                const response = await fetch('/simulate_data');
                const data = await response.json();
                
                // Update injection state from server
                injectionActive = data.inject_active;
                // Update active failed components list from server
                if (data.failed_components) {
                    activeFailedComponents = data.failed_components;
                }
                updateInjectionUI();
                
                // Update all visualizations
                updateSystemStatus(data.is_anomaly, data.reconstruction_error, data.threshold);
                // Pass anomalous_parameters for per-sensor highlighting
                updateSensorReadings(data.sensor_readings, data.is_anomaly, data.anomalous_parameters || []);
                updatePCAPlot(data.pca_coords, data.is_anomaly);
                updateCharts(data.time_series);
                updateTruckComponents(data.affected_components);
                
                // Update failure probability panel
                updateFailureProbabilities(data.failure_probabilities, data.failed_components);
                
            } catch (error) {
                console.error('Error fetching data:', error);
            }
        }

        // Start streaming
        function startStream() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
            }
            
            isStreaming = true;
            simulationInterval = setInterval(fetchData, 400);
            
            const btn = document.getElementById('btn-simulate');
            btn.innerHTML = '‚è∏ Pause Stream';
            
            const dotAuto = document.getElementById('dot-auto');
            const labelAuto = document.getElementById('label-auto');
            dotAuto.className = 'status-dot active';
            labelAuto.textContent = 'Auto Mode: ON';
        }

        // Stop streaming
        function stopStream() {
            if (simulationInterval) {
                clearInterval(simulationInterval);
                simulationInterval = null;
            }
            
            isStreaming = false;
            
            const btn = document.getElementById('btn-simulate');
            btn.innerHTML = 'üìä Simulate Normal';
            
            const dotAuto = document.getElementById('dot-auto');
            const labelAuto = document.getElementById('label-auto');
            dotAuto.className = 'status-dot inactive';
            labelAuto.textContent = 'Auto Mode: OFF';
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', () => {
            initPlots();
            
            // Get initial injection state including any active failures and probabilities
            fetch('/get_injection_state')
                .then(r => r.json())
                .then(data => {
                    injectionActive = data.inject_anomaly;
                    activeFailedComponents = data.failed_components || [];
                    updateInjectionUI();
                    // Update probability panel with initial data
                    if (data.failure_probabilities) {
                        updateFailureProbabilities(data.failure_probabilities, data.failed_components);
                    }
                });
            
            // Also fetch probability data separately to ensure it's displayed
            fetch('/get_failure_probabilities')
                .then(r => r.json())
                .then(data => {
                    if (data.probabilities) {
                        updateFailureProbabilities(data.probabilities, activeFailedComponents);
                    }
                });
        });
    </script>
</body>
</html>
